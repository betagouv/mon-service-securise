const expect = require('expect.js');
const {
  fabriqueServiceVerificationCoherenceSels,
} = require('../../src/sel/serviceVerificationCoherenceSels');
const { ErreurHashDeSelInvalide } = require('../../src/erreurs');

describe('Le service de vÃ©rification de cohÃ©rence des sels de hashage', () => {
  describe('sur demande de vÃ©rification des sels', () => {
    let serviceVerificationCoherenceSels;
    let depotDonnees;
    let adaptateurEnvironnement;

    beforeEach(() => {
      depotDonnees = {
        verifieLaCoherenceDesSels: () => {},
      };
      adaptateurEnvironnement = {
        modeMaintenance: () => ({
          actif: () => false,
        }),
      };
      serviceVerificationCoherenceSels =
        fabriqueServiceVerificationCoherenceSels({
          depotDonnees,
          adaptateurEnvironnement,
        });
    });

    it("ne fait rien si l'application est en mode maintenance", async () => {
      const exitActuel = process.exit;
      let depotAppele = false;
      depotDonnees.verifieLaCoherenceDesSels = () => {
        depotAppele = true;
      };
      adaptateurEnvironnement.modeMaintenance = () => ({ actif: () => true });

      await serviceVerificationCoherenceSels.verifieLaCoherenceDesSels();
      expect(depotAppele).to.be(false);

      process.exit = exitActuel;
    });

    it('ne fait rien si les sels sont cohÃ©rents', async () => {
      try {
        await serviceVerificationCoherenceSels.verifieLaCoherenceDesSels();
      } catch (e) {
        expect().fail(e);
      }
    });

    describe('lorsque les sels sont incohÃ©rents', () => {
      let exitActuel;

      beforeEach(() => {
        exitActuel = process.exit;
      });

      afterEach(() => {
        process.exit = exitActuel;
      });

      it("termine l'application", async () => {
        let codeRecu;
        process.exit = (codeDeRetour) => (codeRecu = codeDeRetour);

        depotDonnees.verifieLaCoherenceDesSels = () => {
          throw new ErreurHashDeSelInvalide();
        };

        await serviceVerificationCoherenceSels.verifieLaCoherenceDesSels();

        expect(codeRecu).to.be(1);
      });

      it("Ã©crit l'erreur sur la console", async () => {
        const sortieStandardActuelle = process.stdout;
        let erreurRecue;
        process.exit = () => undefined;
        process.stdout.write = (e) => (erreurRecue = e);

        depotDonnees.verifieLaCoherenceDesSels = () => {
          throw new ErreurHashDeSelInvalide(
            'La version 1 du sel est invalide.'
          );
        };

        await serviceVerificationCoherenceSels.verifieLaCoherenceDesSels();

        expect(erreurRecue).to.be(
          'ðŸ’¥ Erreur de vÃ©rification des sels: La version 1 du sel est invalide.\n'
        );

        process.stdout = sortieStandardActuelle;
      });
    });
  });
});
