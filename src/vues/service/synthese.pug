extends ../deuxColonnes
include ../cartes/indiceCyber
include ../cartes/recommandationsANSSI
include ../fragments/cartesInformations
include ../fragments/texteTronque

mixin action({ id, description, sousTitre, url, statut })
  a(href = url)
    .action(class = `${id}`)
      -
        const statutSaisie = (statut) => {
          switch (statut) {
            case InformationsHomologation.COMPLETES:
              return 'faite';
            case InformationsHomologation.A_COMPLETER:
              return 'en-cours';
            default:
              return '';
          }
        }
      .statut(class = statutSaisie(statut))
      div(class = `icone-action`)
      h2= description
      .sous-titre= sousTitre

mixin outilComplementaire({ id, nom, description, lien })
  .outil-complementaire(class = id)
    .titre-outil
      .icone-outil
      h3= nom
    .description #{description} #[a.avec-chevron(href = lien.url)= lien.texte]

block append styles
  link(href = '/statique/assets/styles/homologation/synthese.css', rel = 'stylesheet')

block retour
  nav.fil-ariane
    a.avec-chevron(href = '/tableauDeBord') Tableau de bord
    div: +texteTronque({ texte: service.nomService() })

block zone-principale
  .details-service
    h1.titre-service!= service.nomService()

    .actions
      each actionSaisie in actionsSaisie
        +action(actionSaisie)

    .cartes-outils-complementaires
      h2 Outils complémentaires
      .outils-complementaires
        +outilComplementaire({
          id: 'risques',
          nom: 'Risques',
          description: 'Cartographiez les impacts potentiels des risques de sécurité les plus courants.',
          lien: { url: `/service/${service.id}/risques`, texte: 'Remplir'}
        })
        +outilComplementaire({
          id: 'contactsUtiles',
          nom: 'Contacts utiles',
          description: 'Créez la liste des personne contribuant au fonctionnement du service à contacter en cas de besoin.',
          lien: { url: `/service/${service.id}/rolesResponsabilites`, texte: 'Compléter' }
        })

    .telechargement-pdfs
      a.bouton.nouvel-onglet(
        href = `/api/service/${service.id}/pdf/syntheseSecurite.pdf`,
        target = `blank`,
        rel = ``
      ) Télécharger la synthèse
      a.bouton.nouvel-onglet(
        href = `/api/service/${service.id}/pdf/annexes.pdf`,
        target = `blank`,
        rel = ``
      ) Télécharger les annexes

block cartes-informations
  -
    const dossiers = service.dossiers
    const idStatutHomologation = dossiers.statutHomologation()
    const detailStatutHomologation = referentiel.statutHomologation(idStatutHomologation)
    const dossierActif = dossiers.dossierActif()
    const etapeCourante = dossiers.dossierCourant()?.etapeCourante() ?? referentiel.premiereEtapeParcours().id
    const dateExpiration = dossiers.finalises().find((dossier) => dossier.estExpire())?.descriptionProchaineDateHomologation();

  +carteInformations({titre: "Homologation de sécurité" })
    .statut.statut-homologation(class=idStatutHomologation, data-id-statut=idStatutHomologation)
      span= detailStatutHomologation.libelle

    .informations-complementaires-statut
      case idStatutHomologation
        when 'aRealiser'
          a.avec-chevron(href = `/service/${service.id}/homologation/edition/etape/${etapeCourante}`) Commencer l'homologation
        when 'aFinaliser'
          a.avec-chevron(href = `/service/${service.id}/homologation/edition/etape/${etapeCourante}`) Poursuivre l'homologation
        when 'realisee'
          .dates-statut.
            Durée : #{dossierActif.descriptionDureeValidite()}
          .dates-statut.
            Valable jusqu'au #{dossierActif.descriptionProchaineDateHomologation()}
        when 'bientotExpiree'
          .dates-statut.
            Expire le #{dossierActif.descriptionProchaineDateHomologation()}
          a.avec-chevron(href = `/service/${service.id}/homologation/edition/etape/${etapeCourante}`) Renouveler l'homologation
        when 'expiree'
          .dates-statut.
            Expirée depuis le #{dateExpiration}
          a.avec-chevron(href = `/service/${service.id}/homologation/edition/etape/${etapeCourante}`) Renouveler l'homologation


  - const indiceCyber = service.indiceCyber()
  +indiceCyber({ referentiel, indiceCyber })

  +recommandationsANSSI({ referentiel, noteObtenue: indiceCyber.total })

  +carteInformations({ titre: 'Pour les services référencés avant le 12/10/2022' })
    .liens
      a.avec-chevron(href = `/service/${service.id}/avisExpertCyber`) Accéder à « Avis sur le dossier »
      a.avec-chevron(href = `/service/${service.id}/decision`) Télécharger les annexes 1ère version
